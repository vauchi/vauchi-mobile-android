# GitLab CI for vauchi-mobile-android
#
# Android library distribution for VauchiMobile
#
# This pipeline:
# - Builds the AAR library
# - Publishes to GitLab Maven registry
# - Auto-updates on upstream release triggers

include:
  - project: 'vauchi/scripts'
    ref: main
    file: '/ci-templates/reuse.yml'

# Generated repo â€” REUSE headers may be incomplete
reuse-lint:
  allow_failure: true

stages:
  - lint
  - build
  - publish
  - notify

workflow:
  auto_cancel:
    on_new_commit: interruptible

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

# Build AAR library
build:aar:
  stage: build
  image: cimg/android:2024.01
  script:
    - ./gradlew :vauchi-mobile:assembleRelease
  artifacts:
    paths:
      - vauchi-mobile/build/outputs/aar/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v/

# Publish to GitLab Maven
publish:maven:
  stage: publish
  image: cimg/android:2024.01
  needs:
    - build:aar
  script:
    - ./gradlew :vauchi-mobile:publishReleasePublicationToGitLabRepository
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/

# Triggered by upstream vauchi/core release
# Downloads native libs and updates the library
update:bindings:
  stage: build
  image: cimg/android:2024.01
  resource_group: bindings-update
  rules:
    # Accept all trigger sources:
    #   "trigger" = Pipeline Trigger API (trigger-downstream.sh from CI)
    #   "pipeline" = GitLab trigger: keyword (multi-project pipeline)
    #   "api" = Pipeline API with PRIVATE-TOKEN (trigger-downstream.sh locally, or glab)
    - if: ($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "pipeline" || $CI_PIPELINE_SOURCE == "api") && $UPSTREAM_VERSION
  script:
    - |
      echo "Updating to version $UPSTREAM_VERSION"

      # Strip v prefix for package version
      CLEAN_VERSION="${UPSTREAM_VERSION#v}"

      # Download Android bindings from upstream
      PACKAGE_URL="https://gitlab.com/api/v4/projects/vauchi%2Fcore/packages/generic/vauchi-mobile/$CLEAN_VERSION"
      echo "Downloading from: $PACKAGE_URL"

      curl -sfL -o android-bindings.zip "$PACKAGE_URL/vauchi-mobile-android-$CLEAN_VERSION.zip"
      unzip android-bindings.zip

      # Copy JNI libs
      mkdir -p vauchi-mobile/src/main/jniLibs
      cp -r vauchi-mobile-android-$CLEAN_VERSION/jniLibs/* vauchi-mobile/src/main/jniLibs/

      # Copy Kotlin bindings
      mkdir -p vauchi-mobile/src/main/kotlin/uniffi
      cp -r vauchi-mobile-android-$CLEAN_VERSION/kotlin/uniffi/* vauchi-mobile/src/main/kotlin/uniffi/

      # Update version
      sed -i "s/const val VERSION = \".*\"/const val VERSION = \"$CLEAN_VERSION\"/" \
        vauchi-mobile/src/main/kotlin/com/vauchi/mobile/VauchiMobile.kt

      # Build and publish
      VERSION=$CLEAN_VERSION ./gradlew :vauchi-mobile:assembleRelease :vauchi-mobile:publishReleasePublicationToGitLabRepository

      # Configure git to push via CI_JOB_TOKEN
      git config user.email "ci@vauchi.com"
      git config user.name "Vauchi CI"
      git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"

      git add -A
      git commit -m "chore: Update to $UPSTREAM_VERSION"
      git tag "$UPSTREAM_VERSION"
      git push origin HEAD:main --tags

# Notify consumer app about new bindings version
# Triggers vauchi/android to create an MR bumping the dependency
notify:android-app:
  stage: notify
  image: alpine:latest
  resource_group: notify-downstream
  needs:
    - update:bindings
  rules:
    - if: ($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "pipeline" || $CI_PIPELINE_SOURCE == "api") && $UPSTREAM_VERSION
  allow_failure: true
  before_script:
    - apk add --no-cache curl
  script:
    - |
      CLEAN_VERSION="${UPSTREAM_VERSION#v}"
      echo "Notifying vauchi/android about version $CLEAN_VERSION"

      ANDROID_APP_PROJECT_ID="77813123"

      response=$(curl -s -w "\n%{http_code}" \
        --request POST \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{\"ref\": \"main\", \"variables\": [{\"key\": \"BINDINGS_VERSION\", \"value\": \"$CLEAN_VERSION\"}]}" \
        "${CI_SERVER_URL}/api/v4/projects/$ANDROID_APP_PROJECT_ID/pipeline")

      http_code=$(echo "$response" | tail -n1)
      body=$(echo "$response" | head -n -1)

      if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
        echo "Triggered android app pipeline: $(echo "$body" | grep -o '"web_url":"[^"]*"' | head -1)"
      else
        echo "Failed to trigger ($http_code): $body"
        exit 1
      fi
